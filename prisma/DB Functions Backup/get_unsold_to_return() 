-- DROP FUNCTION public.get_unsold_to_return();

CREATE OR REPLACE FUNCTION public.get_unsold_to_return()
 RETURNS json
 LANGUAGE plpgsql
AS $function$
DECLARE
    results_json json;
BEGIN
    SELECT json_agg(json_build_object(
        'ID Vendeur', s.id,
        'Nom', CONCAT(s.firstname, ' ', s.name),
        'ID Article', a.id,
        'Article', a.name
    ))
    INTO results_json
    FROM
        "Seller" s
    JOIN
        "Article" a ON s.id = a.seller_id
    WHERE
        a.state = 2
        AND s.return_articles = true; -- Ajout de la condition sur return_articles

    RETURN results_json;
END;
$function$
;
